<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Participate - EventSys</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <!-- Confetti script for success -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <link rel="stylesheet" href="styles.css">
    <style>
        .sticky-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            backdrop-filter: blur(24px);
            padding: 1.5rem 5%;
            border-top: 1px solid var(--card-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.1);
            transform: translateY(100%);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .sticky-bar.visible {
            transform: translateY(0);
        }

        .selectable-card {
            cursor: pointer;
        }

        .selectable-card input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
    </style>
</head>

<body>

    <!-- Background Blobs -->
    <div class="mesh-bg participate-bg"></div>
    <div class="blob-bg">
        <div class="blob blob-2" style="background: var(--primary-color); opacity: 0.2"></div>
        <div class="blob blob-3" style="background: var(--accent-color); opacity: 0.1"></div>
    </div>

    <nav class="navbar" id="navbar">
        <div class="nav-brand">
            <div
                style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white;">
                <i class="fa-solid fa-graduation-cap"></i>
            </div>
            <span class="text-gradient">EventSys</span>
        </div>
        <ul class="nav-links">
            <li><a href="index.html" class="nav-link">Home</a></li>
            <li><a href="events.html" class="nav-link">Explore</a></li>
            <li><a href="participate.html" class="nav-link active">Participate</a></li>
            <li><a href="student-dashboard.html" class="nav-link">Dashboard</a></li>
            <li><a href="admin.html" class="nav-link">Admin</a></li>
        </ul>
        <div class="nav-actions">
            <button class="theme-toggle" aria-label="Toggle Dark Mode"><i class="fa-solid fa-moon"></i></button>
            <a href="login.html" class="btn btn-outline" style="padding: 0.5rem 1rem;">Login</a>
            <button class="hamburger" aria-label="Menu"><i class="fa-solid fa-bars"></i></button>
        </div>
    </nav>

    <main class="main-content" style="padding-bottom: 8rem;">

        <section>
            <div class="section-header" data-aos="fade-down" style="margin-bottom: 2rem;">
                <div class="badge badge-tech mb-2" style="font-size: 0.9rem; padding: 0.5rem 1rem;"><i
                        class="fa-solid fa-gamepad"></i> Mission Selection</div>
                <h1 class="section-title text-gradient"
                    style="font-size: 3.5rem; text-shadow: 0 4px 20px rgba(0,0,0,0.3);">Build Your Schedule</h1>
                <p class="section-subtitle">Select events to build your ultimate mission lineup and earn XP.</p>
            </div>

            <!-- Identity Panel (Upgraded) -->
            <div class="glass"
                style="padding: 2.5rem; margin-bottom: 3rem; position: relative; overflow: visible; border: 1px solid rgba(99,102,241,0.2);"
                data-aos="fade-up">

                <h2
                    style="font-size: 1.4rem; margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 0.8rem;">
                        <div
                            style="width: 32px; height: 32px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; box-shadow: 0 0 15px rgba(99,102,241,0.5);">
                            <i class="fa-solid fa-user-shield"></i>
                        </div>
                        Verify Identity
                    </div>
                    <div id="welcomeMessage"
                        style="font-size: 1rem; color: var(--color-success); font-weight: 600; opacity: 0; transition: opacity 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem;">
                        Welcome back, <span id="welcomeName"></span> ðŸ‘‹
                    </div>
                </h2>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    <div class="form-floating">
                        <input type="text" id="regNo" class="form-control" placeholder="Register Number" required
                            style="border-radius: var(--radius-md); background: rgba(0,0,0,0.2); border: 2px solid rgba(255,255,255,0.1);">
                        <label for="regNo">Register Number (e.g. 2026CSE101)</label>
                        <i class="fa-solid fa-circle-check validation-icon success"></i>
                    </div>
                    <div class="form-floating">
                        <input type="text" id="sName" class="form-control" placeholder="Full Name" required
                            style="border-radius: var(--radius-md); background: rgba(0,0,0,0.2); border: 2px solid rgba(255,255,255,0.1);">
                        <label for="sName">Full Name</label>
                        <i class="fa-solid fa-circle-check validation-icon success"></i>
                    </div>
                </div>
            </div>

            <!-- Smart Filter Bar -->
            <div data-aos="fade-up"
                style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem;">
                <!-- Filter Chips -->
                <div style="display: flex; gap: 0.8rem; overflow-x: auto; padding-bottom: 0.5rem;" class="filter-chips">
                    <button class="chip active">All Events</button>
                    <button class="chip"><i class="fa-solid fa-code"></i> Technical</button>
                    <button class="chip"><i class="fa-solid fa-palette"></i> Cultural</button>
                    <button class="chip"><i class="fa-solid fa-fire"></i> High XP</button>
                    <button class="chip"><i class="fa-solid fa-clock"></i> Upcoming</button>
                </div>

                <!-- Search & Sort -->
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <div style="position: relative;">
                        <input type="text" class="form-control" placeholder="Search events..."
                            style="padding-left: 2.5rem; width: 250px; background: rgba(0,0,0,0.2); border-color: rgba(255,255,255,0.1); border-radius: var(--radius-pill);">
                        <i class="fa-solid fa-search"
                            style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-secondary);"></i>
                    </div>
                    <select class="form-control"
                        style="width: auto; background: rgba(0,0,0,0.2); border-color: rgba(255,255,255,0.1); border-radius: var(--radius-pill);">
                        <option>Sort by Date</option>
                        <option>Sort by XP (High to Low)</option>
                        <option>Sort by Popularity</option>
                    </select>
                </div>
            </div>

            <!-- Event Grid -->
            <div class="grid-cards" id="dynamicParticipateGrid">
                <!-- Dynamically injected events go here -->
            </div>

            <!-- Empty State (Hidden) -->
            <div id="participateEmptyState" style="display: none; text-align: center; padding: 4rem 2rem;">
                <i class="fa-solid fa-folder-open"
                    style="font-size: 4rem; color: var(--text-secondary); margin-bottom: 1.5rem;"></i>
                <h3 style="font-size: 1.5rem; color: var(--text-primary); margin-bottom: 0.5rem;">No Events Available
                </h3>
                <p style="color: var(--text-secondary);">There are currently no active events to participate in.</p>
            </div>
        </section>

    </main>

    <!-- ðŸ§  Live Selection Summary Bar -->
    <div class="sticky-bar glass sticky-footer" id="stickyConfirm">
        <div style="display: flex; align-items: center; gap: 2rem; flex: 1;">
            <!-- XP Projection Circular UI -->
            <div style="position: relative; width: 60px; height: 60px;">
                <svg viewBox="0 0 100 100"
                    style="position: absolute; top:0; left:0; width:100%; height:100%; transform: rotate(-90deg);">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="8" />
                    <circle id="xpProgressCircle" cx="50" cy="50" r="45" fill="none" stroke="url(#xpGradient)"
                        stroke-width="8" stroke-dasharray="283" stroke-dashoffset="283"
                        style="transition: stroke-dashoffset 0.8s cubic-bezier(0.4, 0, 0.2, 1); stroke-linecap: round;" />
                    <defs>
                        <linearGradient id="xpGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" stop-color="var(--primary-color)" />
                            <stop offset="100%" stop-color="var(--secondary-color)" />
                        </linearGradient>
                    </defs>
                </svg>
                <div style="position: absolute; top:50%; left:50%; transform: translate(-50%, -50%); color: white; font-weight: 800; font-size: 0.9rem;"
                    id="selCount">0</div>
            </div>

            <!-- Summary Text -->
            <div>
                <h3 style="margin-bottom: 0.2rem; font-size: 1.3rem; display: flex; align-items: center; gap: 0.8rem;">
                    Mission Ready
                    <span id="projXP"
                        style="color: var(--color-success); font-size: 1.1rem; opacity: 0; transition: opacity 0.3sease; background: rgba(16,185,129,0.1); padding: 0.2rem 0.6rem; border-radius: 6px;">+0
                        XP</span>
                </h3>
                <p class="text-secondary" style="font-size: 0.95rem; margin: 0;" id="milestoneMsg">Select more events to
                    build your projection.</p>
            </div>
        </div>

        <button class="btn btn-primary btn-lg"
            style="padding: 1rem 2.5rem; font-size: 1.1rem; box-shadow: 0 0 20px rgba(99,102,241,0.4);"
            onclick="confirmParticipation()">
            <i class="fa-solid fa-rocket" style="margin-right: 0.8rem;"></i> Lock In Schedule
        </button>
    </div>

    <!-- ðŸ† Premium Upgraded Summary Modal -->
    <div class="modal-overlay" id="summaryModal">
        <div class="modal-content glass"
            style="max-width: 600px; padding: 3.5rem; border: 1px solid rgba(255,255,255,0.2);">

            <div id="modalSuccessAnim" style="margin-bottom: 2rem;">
                <div
                    style="width: 80px; height: 80px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; box-shadow: 0 0 30px rgba(16,185,129,0.5);">
                    <i class="fa-solid fa-check" style="font-size: 2.5rem; color: white;"></i>
                </div>
            </div>

            <h2 style="font-size: 2.2rem; margin-bottom: 0.5rem; text-shadow: 0 2px 10px rgba(0,0,0,0.5);">System
                Linked!</h2>
            <p class="text-secondary" style="margin-bottom: 1.5rem; font-size: 1.1rem;">You successfully locked in your
                attendance.</p>

            <!-- XP Gained Callout -->
            <div
                style="background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(168,85,247,0.15)); border: 1px solid rgba(168,85,247,0.3); border-radius: var(--radius-lg); padding: 1.5rem; margin-bottom: 2rem;">
                <div
                    style="font-size: 0.9rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem;">
                    Projected Gain</div>
                <div style="font-size: 2.5rem; font-weight: 800; color: var(--primary-color); text-shadow: 0 0 20px rgba(99,102,241,0.5);"
                    id="modalXPGain">+0 XP</div>
            </div>

            <div id="summaryList"
                style="text-align: left; background: rgba(0,0,0,0.2); padding: 1.5rem; border-radius: var(--radius-lg); max-height: 200px; overflow-y: auto; margin-bottom: 2.5rem; border: 1px solid rgba(255,255,255,0.05);">
            </div>

            <div style="display: flex; gap: 1rem; justify-content: center;">
                <a href="student-dashboard.html" class="btn btn-primary" style="width: 50%;">Go to Command Center</a>
                <button onclick="closeModal('summaryModal'); window.location.reload();" class="btn btn-outline"
                    style="background: transparent; border-color: rgba(255,255,255,0.1); color: var(--text-secondary); width: auto;">Close</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="app.js"></script>
    <script>
        // 1. Identity Verification Logic
        const regNo = document.getElementById('regNo');
        const sName = document.getElementById('sName');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const welcomeName = document.getElementById('welcomeName');

        function checkIdentity() {
            if (regNo.value.length > 5 && sName.value.length > 2) {
                regNo.classList.add('is-valid');
                sName.classList.add('is-valid');
                welcomeName.textContent = sName.value.split(" ")[0]; // First name
                welcomeMessage.style.opacity = '1';
            } else {
                regNo.classList.remove('is-valid');
                sName.classList.remove('is-valid');
                welcomeMessage.style.opacity = '0';
            }
        }

        regNo.addEventListener('input', checkIdentity);
        sName.addEventListener('input', checkIdentity);


        // 2. Event Selection & Gamification Logic
        const stickyBar = document.getElementById('stickyConfirm');
        const selCount = document.getElementById('selCount');
        const summaryList = document.getElementById('summaryList');
        const xpProgressCircle = document.getElementById('xpProgressCircle');
        const projXP = document.getElementById('projXP');
        const milestoneMsg = document.getElementById('milestoneMsg');
        const modalXPGain = document.getElementById('modalXPGain');

        let totalXP = 0;
        const XP_MAX = 1000; // Cap for the visual circle

        document.addEventListener('change', function (e) {
            if (e.target.matches('.selectable-card input[type="checkbox"]')) {
                const box = e.target;
                const card = box.closest('.selectable-card');
                let xpVal = parseInt(card.getAttribute('data-xp')) || 0;

                // Apply Global XP Multiplier
                if (typeof SettingsManager !== 'undefined' && SettingsManager.settings) {
                    const multiplier = SettingsManager.settings.configuration.globalXpMultiplier || 1.0;
                    xpVal = Math.round(xpVal * multiplier);
                }

                if (box.checked) {
                    card.classList.add('selected');
                    totalXP += xpVal;
                    createFloatingXP(e.clientX, e.clientY, xpVal);
                } else {
                    card.classList.remove('selected');
                    totalXP -= xpVal;
                }
                updateStickyBar();
            }
        });

        function createFloatingXP(x, y, amount) {
            const el = document.createElement('div');
            el.className = 'floating-xp';
            el.textContent = "+" + amount + " XP";
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function updateStickyBar() {
            const count = document.querySelectorAll('.selectable-card input[type="checkbox"]:checked').length;
            selCount.textContent = count;

            // Calculate Circle Dash Offset (283 is total circumference)
            const fillPercentage = Math.min((totalXP / XP_MAX), 1);
            const dashOffset = 283 - (283 * fillPercentage);
            xpProgressCircle.style.strokeDashoffset = dashOffset;

            // Update Text
            if (count > 0) {
                stickyBar.classList.add('visible');
                projXP.textContent = "+" + totalXP + " XP";
                projXP.style.opacity = '1';

                if (totalXP >= 500) {
                    milestoneMsg.textContent = "Awesome! You are projected to hit Level 10.";
                } else if (totalXP >= 200) {
                    milestoneMsg.textContent = "Great choices, building a solid foundation.";
                } else {
                    milestoneMsg.textContent = "Select more events to build your projection.";
                }
            } else {
                stickyBar.classList.remove('visible');
                projXP.style.opacity = '0';
            }
        }

        // 3. Filter Chips Logic
        const filterChips = document.querySelectorAll('.filter-chips .chip');

        filterChips.forEach(chip => {
            chip.addEventListener('click', function () {
                // Update active state
                filterChips.forEach(c => c.classList.remove('active'));
                this.classList.add('active');

                const filterText = this.textContent.trim();
                const eventTiles = document.querySelectorAll('.event-tile');

                eventTiles.forEach(tile => {
                    const category = tile.getAttribute('data-category');
                    if (filterText === 'All Events') {
                        tile.style.display = 'flex';
                    } else if (filterText.includes('Technical') && (category === 'Technical' || category === 'Workshop')) {
                        tile.style.display = 'flex';
                    } else if (filterText.includes('Cultural') && category === 'Cultural') {
                        tile.style.display = 'flex';
                    } else if (filterText.includes('High XP') && parseInt(tile.getAttribute('data-xp')) >= 200) {
                        tile.style.display = 'flex';
                    } else if (filterText.includes('Upcoming') && tile.querySelector('.text-warning')) {
                        tile.style.display = 'flex';
                    } else {
                        tile.style.display = 'none';
                    }
                });
            });
        });

        // 4. Confirmation Process
        function confirmParticipation() {
            if (!regNo.classList.contains('is-valid') || !sName.classList.contains('is-valid')) {
                // Flash Identity card if invalid
                const identityCard = document.querySelector('.glass');
                identityCard.style.borderColor = 'rgba(239, 68, 68, 0.5)';
                setTimeout(() => identityCard.style.borderColor = 'rgba(99,102,241,0.2)', 1000);
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }

            const selectedBoxes = document.querySelectorAll('.selectable-card input[type="checkbox"]:checked');

            if (selectedBoxes.length === 0) {
                if (typeof window.showToast === 'function') window.showToast('Select at least one event.', 'warning');
                return;
            }

            const eventTitles = Array.from(selectedBoxes).map(box => box.value);
            const studentId = document.getElementById('regNo').value;
            const studentName = document.getElementById('sName').value;

            // Save to database
            const response = RegistrationManager.registerForEvents(studentId, studentName, eventTitles);

            if (!response.success) {
                if (typeof window.showToast === 'function') window.showToast(response.message, 'error');
                return;
            }

            summaryList.innerHTML = '';
            modalXPGain.textContent = "+" + totalXP + " XP";

            selectedBoxes.forEach((box, index) => {
                const title = box.value;
                const date = box.getAttribute('data-date');
                const venue = box.getAttribute('data-venue');
                const card = box.closest('.event-tile');
                const xp = card.getAttribute('data-xp');
                const cat = card.getAttribute('data-category');

                summaryList.innerHTML += `
          <div style="padding: 1rem; border-bottom: ${index === selectedBoxes.length - 1 ? 'none' : '1px solid rgba(255,255,255,0.05)'};">
            <div style="display:flex; justify-content: space-between; align-items:flex-start;">
                <h4 style="margin: 0; font-size: 1.1rem; color: var(--primary-color);">${title}</h4>
                <div class="xp-badge" style="padding: 0.1rem 0.6rem; font-size: 0.75rem;">+${xp} XP</div>
            </div>
            <div style="font-size: 0.85rem; color: var(--text-secondary); display: flex; gap: 1.5rem; margin-top: 0.5rem;">
              <span><i class="fa-regular fa-calendar" style="color:var(--primary-color)"></i> ${date}</span>
              <span><i class="fa-solid fa-location-dot" style="color:var(--accent-color)"></i> ${venue}</span>
            </div>
          </div>
        `;
            });

            showModal('summaryModal');
            // Trigger global confetti from app.js
            setTimeout(fireConfetti, 300);

            // Uncheck and disable the registered cards visually
            selectedBoxes.forEach(box => {
                box.checked = false;
                const card = box.closest('.event-tile');
                card.classList.remove('selected');
                card.classList.add('disabled-card');
                box.disabled = true;
            });
            totalXP = 0;
            updateStickyBar();
        }
    </script>
</body>

</html>